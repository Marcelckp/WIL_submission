generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Company {
  id        String   @id @default(cuid())
  name      String
  vatNumber String?
  address   String?
  logoUrl   String?
  createdAt DateTime @default(now())
  users     User[]
  boqs      Boq[]
  invoices  Invoice[]
}

model User {
  id           String    @id @default(cuid())
  companyId    String
  role         String    // ADMIN or FIELD
  name         String
  email        String    @unique
  passwordHash String
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  company      Company   @relation(fields: [companyId], references: [id])
  boqs         Boq[]
  invoices     Invoice[]
  comments     Comment[]
}

model Boq {
  id        String    @id @default(cuid())
  companyId String
  name      String
  version   Int
  uploadedBy String
  status    String    // ACTIVE or ARCHIVED
  createdAt DateTime  @default(now())
  company   Company   @relation(fields: [companyId], references: [id])
  uploader  User      @relation(fields: [uploadedBy], references: [id])
  items     BoqItem[]
}

model BoqItem {
  id              String  @id @default(cuid())
  boqId           String
  sapNumber       String
  shortDescription String
  unit            String
  rate            String  // decimal as string
  category        String?
  searchableText  String?
  boq             Boq     @relation(fields: [boqId], references: [id], onDelete: Cascade)
  
  @@index([boqId, sapNumber])
  @@index([boqId, searchableText])
}

model Invoice {
  id                  String       @id @default(cuid())
  companyId           String
  invoiceNumber       String?      @unique
  date                String
  customerName        String
  projectSite         String?
  preparedBy          String?
  subtotal            String?      // decimal as string
  vatPercent          String?      // decimal as string
  vatAmount           String?      // decimal as string
  total               String?      // decimal as string
  createdBy           String
  status              String       // DRAFT, SUBMITTED, APPROVED, REJECTED, FINAL
  approvedBy          String?
  approvedAt          DateTime?
  rejectionReason     String?
  rejectedAt          DateTime?
  rejectedBy          String?
  serverPdfUrl        String?
  clientPdfUrl        String?
  lastSyncedBoqVersion String?
  // Metadata snapshot - immutable after submission, contains invoice content summary
  metadataSnapshot    String?      // JSON string with invoice content: lineItemCount, itemSummary, etc.
  lineItemCount       Int?         // Number of line items in invoice
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  submittedAt         DateTime?     // Timestamp when invoice was submitted (becomes immutable)
  company             Company       @relation(fields: [companyId], references: [id])
  creator             User          @relation(fields: [createdBy], references: [id])
  lines                InvoiceLine[]
  media                Media[]
  comments             Comment[]
  
  @@index([companyId, status])
  @@index([companyId, invoiceNumber])
}

model InvoiceLine {
  id          String   @id @default(cuid())
  invoiceId   String
  boqItemId   String?
  itemName    String
  description String?
  unit        String
  unitPrice   String   // decimal as string
  quantity    String   // decimal as string
  amount      String   // decimal as string
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
}

model Media {
  id             String   @id @default(cuid())
  invoiceId      String
  url            String
  mimeType       String?
  width          Int?
  height         Int?
  source         String?   // CAMERA or GALLERY
  storageProvider String?  // AZURE_BLOB
  blobContainer  String?
  blobPath       String?
  createdAt      DateTime  @default(now())
  invoice        Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
}

model Comment {
  id        String   @id @default(cuid())
  invoiceId String
  authorId  String
  body      String
  createdAt DateTime  @default(now())
  invoice   Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id])
  
  @@index([invoiceId])
}

